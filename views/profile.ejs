<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PROFILE | <%= name%></title>
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/stylesheets/global.css" />
    <link rel="stylesheet" href="/stylesheets/profileStyle.css" />
  </head>
  <body>
    <div class="main">
      <div class="nav">
        <div class="navUserName">
          <div class="userImg">
            <img
              src="https://png.pngtree.com/element_our/20200610/ourmid/pngtree-black-default-avatar-image_2237212.jpg"
              alt=""
            />
          </div>
          <h2 class="userNameID" id="<%=userID%>">WELCOME <%=name%> !</h2>
        </div>

        <button id="logout-action">LOG OUT</button>
      </div>
      <div class="profileContainer">
        <div class="profile-left">
          <div class="profile-leftInput">
            <i class="ri-search-line"></i>
            <input type="text" placeholder="Looking  For" />
          </div>
          <div class="headingOfpassword">Saved Passwords:</div>

          <div class="profile-leftPasswords">
            <%passwords.reverse().forEach((password)=>{ %>
            <div class="passwordCard">
              <div class="siteName">
                <p><%= password.siteName.split(".")[0]%></p>
                <p><%= password.userName%></p>
              </div>
              <div class="copyBtn">
                <i
                  id="<%= password._id%>"
                  class="copyPassword ri-file-copy-line"
                ></i>
                <i id="<%= password._id%>" class="showPassword ri-eye-line"></i>
              </div>
            </div>
            <% }) %>
          </div>
        </div>
        <div class="profile-right">
          <div class="savePasswordContainer">
            <form id="saveDetailsForm" action="post">
              <div class="saveSiteName">
                <label for="siteName">Site Name:</label>
                <input
                  type="text"
                  name="siteName"
                  placeholder="Type Site Name"
                />
              </div>
              <div class="saveUserName">
                <label for="userName">Username:</label>
                <input
                  type="text"
                  name="userName"
                  placeholder="Type Username"
                />
              </div>
              <div class="savePassword">
                <label for="password">Password:</label>
                <input
                  type="password"
                  name="password"
                  placeholder="Type Password"
                />
              </div>
              <div class="saveButton">
                <input type="submit" value="Save" />
              </div>
            </form>
          </div>
          <div class="ShowPasswordContainer">
            <div class="profileRightSitename">
              <p>Google</p>
              <div class="profileRightSitenameBtn">
                <i class="ri-star-fill"></i>
                <button>Edit</button>
              </div>
            </div>
            <div class="siteuserName">
              <p>Username / Email:</p>
              <p>aditya@aditya.com</p>
            </div>
            <div class="sitePassword">
              <p>Password:</p>
              <p>aditya@aditya.com</p>
            </div>
            <div class="siteURL">
              <p>Site URL:</p>
              <p>aditya@aditya.com</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const logout = document.querySelector("#logout-action");
      logout.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await fetch("/api/auth/logout");
          alert("User Logged Out successfully!");
        } catch (err) {
          console.log(`Failed to logout`, err);
          alert("Logout Failed");
        } finally {
          window.location.reload();
        }
      });

      const showPasswordBoxes = document.querySelectorAll(".showPassword");
      showPasswordBoxes.forEach((showPassword) => {
        showPassword.addEventListener("click", async (e) => {
          const response = await fetch(`/api/fetchOnePassword/${e.target.id}`);
          const data = await response.json();
          console.log(data.password.siteName);
          const prfileRightContent = `
          <div class="profileRightSitename">
            <p>${data.password.siteName.split(".")[0]}</p>
            <div class="profileRightSitenameBtn">
              <i class="ri-star-fill"></i>
              <button>Edit</button>
            </div>
          </div>
          <div class="siteuserName">
            <p>Username / Email:</p>
            <p>${data.password.userName}</p>
          </div>
          <div class="sitePassword">
            <p>Password:</p>
            <p>${data.password.password}</p>
          </div>
          <div class="siteURL">
            <p>Site URL:</p>
            <p>https://www.${data.password.siteName}</p>
          </div>
        `;
          const profileRightContainer = (document.querySelector(
            ".ShowPasswordContainer"
          ).innerHTML = prfileRightContent);
        });
      });

      const copyPasswordBoxes = document.querySelectorAll(".copyPassword");
      copyPasswordBoxes.forEach((copyPassword) => {
        copyPassword.addEventListener("click", async (e) => {
          console.log(e.target.id);
          const response = await fetch(`/api/fetchOnePassword/${e.target.id}`);
          const data = await response.json();
          const text = data.password.password;
          console.log(text);
          navigator.clipboard.writeText(text).then(() => alert("Copied!"));
        });
      });

      const saveDetailsForm = document.querySelector("#saveDetailsForm");
      saveDetailsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const savedDetails = Object.fromEntries(new FormData(saveDetailsForm));
        console.log(savedDetails.siteName);
        newSavedDetails = {
          siteName: savedDetails.siteName.split(".")[0],
          userName: savedDetails.userName,
          password: savedDetails.password,
        };

        const raw = document.querySelector(".userNameID").getAttribute(`id`);
        const userID = raw.replace(/"/g, "");
        console.log(`/api/savePassword/${userID}`);

        const saveResponse = await fetch(`/api/savePassword/${userID}`, {
          method: "post",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(newSavedDetails),
        });

        const data = await saveResponse.json();

        if (!saveResponse.ok) {
          console.log(data);
          alert(data.error ?? "Failed to save password");
          window.location.reload();
          return;
        } else {
          alert(data.message ?? "Password Saved!");

          window.location.reload();
          return;
        }
        window.location.reload;
      });
    </script>
  </body>
</html>
